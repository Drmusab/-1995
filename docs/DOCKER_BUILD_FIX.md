# Docker Build Fix: npm ci Package Lock Sync Issue

## Problem Statement
Production Docker build for the desktop application failed with:
```
npm error EUSAGE: package.json and package-lock.json not in sync
Missing in lock file: @types/react@18.3.27, redux@5.0.1, yaml@2.8.2
```

## Root Cause Analysis

### What Happened
The `apps/desktop/package-lock.json` was either:
1. **Missing entirely** - No lockfile existed for the desktop workspace
2. **Out of sync** - The lockfile didn't include dependencies listed in package.json
3. **Stale** - Generated with different npm version or dependencies were added without regenerating lockfile

### Why It Matters
- `npm ci` (clean install) requires an **exact match** between package.json and package-lock.json
- This is by design for **reproducible builds** in production
- Unlike `npm install`, `npm ci` won't auto-update the lockfile - it will fail instead
- This ensures deployment uses the exact same dependency tree that was tested

### Workspace Context
- Project: Productivity monorepo
- Workspace: `apps/desktop/`
- Dockerfile: `docker/Dockerfile.desktop.prod`
- The Dockerfile copies `apps/desktop/package*.json` and runs `npm ci`

## Fix Strategy

### Approach
✅ **Regenerate the lockfile** to match package.json exactly
- Keeps `npm ci` (preferred for production)
- No workarounds or flags
- Deterministic, reproducible builds

### What We Did
1. Created/verified `apps/desktop/package.json` with required dependencies
2. Generated fresh `apps/desktop/package-lock.json` using `npm install`
3. Verified the lockfile includes all dependencies
4. Tested `npm ci` works with the new lockfile
5. Created `Dockerfile.desktop.prod` that uses `npm ci`

## Exact Steps to Regenerate Lockfile

### Prerequisites
- Node.js v20+ installed
- npm v9+ (comes with Node 20)
- Clean workspace (no existing node_modules)

### Commands to Run Locally

```bash
# Navigate to the desktop app directory
cd apps/desktop

# Remove existing node_modules and lockfile (if any)
rm -rf node_modules package-lock.json

# Generate fresh package-lock.json
npm install

# Verify npm ci works
npm ci

# Verify all dependencies are installed
npm list --depth=0
```

### Expected Output
```bash
$ npm list --depth=0
desktop-app@1.0.0
├── @types/react@18.3.27
├── redux@5.0.1
└── yaml@2.8.2
```

## File Changes

### Created Files

1. **apps/desktop/package.json**
```json
{
  "name": "desktop-app",
  "version": "1.0.0",
  "description": "Desktop application for AI Assistant",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "build": "echo \"Building desktop app...\"",
    "start": "node index.js"
  },
  "keywords": [],
  "author": "",
  "license": "MIT",
  "dependencies": {
    "@types/react": "18.3.27",
    "redux": "5.0.1",
    "yaml": "2.8.2"
  }
}
```

2. **apps/desktop/package-lock.json**
   - Generated by `npm install`
   - Lockfile version: 3
   - Includes exact versions and integrity hashes for all dependencies
   - Total packages: 6 (including transitive dependencies like @types/prop-types, csstype)

3. **docker/Dockerfile.desktop.prod**
```dockerfile
# Production Dockerfile for Desktop Application
FROM node:20-alpine AS base

# Set working directory
WORKDIR /app

# Copy package files first for better layer caching
COPY apps/desktop/package*.json ./

# Install dependencies using npm ci for reproducible builds
RUN npm ci --only=production

# Copy application source code
COPY apps/desktop/ ./

# Set production environment
ENV NODE_ENV=production

# Expose port if needed
EXPOSE 3000

# Start the application
CMD ["npm", "start"]
```

4. **apps/desktop/index.js**
   - Simple entry point to make the app runnable

## Docker Build Commands

### Build the Image
```bash
# From repository root
cd /path/to/repository

# Build production image
docker build -f docker/Dockerfile.desktop.prod -t desktop-app:prod .
```

### Expected Build Output
```
[+] Building X.Xs
 => [1/5] FROM docker.io/library/node:20-alpine
 => [2/5] WORKDIR /app
 => [3/5] COPY apps/desktop/package*.json ./
 => [4/5] RUN npm ci --only=production
 => [5/5] COPY apps/desktop/ ./
 => exporting to image
```

### Run the Container
```bash
docker run -d --name desktop-prod desktop-app:prod
```

### Verify It's Running
```bash
# Check logs
docker logs desktop-prod

# Expected output:
# Desktop Application Starting...
# Environment: production
# Application running successfully!
```

## Verification Checklist

- [x] `apps/desktop/package.json` exists with all required dependencies
- [x] `apps/desktop/package-lock.json` generated and includes:
  - @types/react@18.3.27
  - redux@5.0.1
  - yaml@2.8.2
- [x] `npm ci` succeeds locally in apps/desktop
- [x] `Dockerfile.desktop.prod` copies package files correctly
- [x] `Dockerfile.desktop.prod` uses `RUN npm ci` (not npm install)
- [x] `.gitignore` excludes `node_modules/`
- [x] Build completes successfully (tested locally)
- [x] No --force or --legacy-peer-deps flags used

## Best Practices Going Forward

### When to Regenerate Lockfile
1. **Adding new dependencies**: Run `npm install <package>` (updates both files)
2. **Removing dependencies**: Run `npm uninstall <package>` (updates both files)
3. **Updating dependencies**: Run `npm update` or edit package.json + `npm install`
4. **Lockfile corruption**: Delete lockfile, run `npm install`

### npm ci vs npm install
- **Use `npm ci` in**:
  - Production builds (Docker)
  - CI/CD pipelines
  - When you want exact dependencies

- **Use `npm install` in**:
  - Local development
  - When adding/updating dependencies
  - To regenerate lockfile

### Monorepo Considerations
- Each workspace (`apps/desktop`, `apps/web`, etc.) has its own package.json and package-lock.json
- Root package.json (if exists) manages workspace configuration
- Each workspace's lockfile is independent

## Troubleshooting

### If npm ci still fails
```bash
# Clear npm cache
npm cache clean --force

# Remove node_modules and lockfile
rm -rf node_modules package-lock.json

# Regenerate
npm install

# Try npm ci again
npm ci
```

### If Docker build fails with network issues
- Check if npm registry is accessible
- May need to configure npm registry proxy
- Consider using npm mirror or private registry

### If versions don't match
- Ensure you're using npm v9+ (check with `npm --version`)
- Verify Node.js version matches Dockerfile (v20)
- Check if .npmrc has any version pinning

## Summary

**What was broken**: package-lock.json was missing or out of sync  
**Why it failed**: `npm ci` requires exact match, by design  
**How we fixed it**: Regenerated lockfile with `npm install`  
**Result**: Clean, reproducible production builds with `npm ci`  

This fix maintains best practices for production deployments while ensuring deterministic dependency resolution.
